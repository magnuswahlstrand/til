---
layout: "../../layouts/BlogPost.astro"
title: "Data migrations with alembic"
datetime: "2022-11-17"
tags: [python, alembic, postgres]
---

A common scenario when working with databases is to add a new fields, that should not be nullable. For example:

```python
class Entity(Base):
    __tablename__ = "entites"
    
    id = Column(String, primary_key=True)
    _type = Column(String, nullable=True) # Added
```

If you create a migration for this, you will get a problem:
```
[23502] ERROR: column "_type" of relation "entities" contains null values
```

We can solve this in two ways:

#### 1. Add a default value
The following will work, and all existing rows will get `standard` as their `_type`.
```python
class Entity(Base):
    __tablename__ = "entites"
    
    id = Column(String, primary_key=True)
    _type = Column(String, nullable=True, default="standard") 
```

#### 2. Add a data migration step

What if we don't want a default value? Then we need to migrate the data for existing rows. I had never done this with Python and alembic before, but I found an [excellent medium post](https://medium.com/the-andela-way/alembic-how-to-add-a-non-nullable-field-to-a-populated-table-998554003134) (by [@erika_dike](https://medium.com/@erika_dike)) that covers this.

We need to add two steps to our migration. 
```python
def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    
    # 1. We add the new column, with nullable=True
    op.add_column(
        'entities',
        sa.Column('_type', sa.String(), nullable=True)
    )
    # 2. Then we run a data migration
    op.execute("UPDATE entities SET _type = 'standard'")
    # 3. Finally, we make the field non-nullable
    op.alter_column('entities', '_type', nullable=False)
    
    # ### end Alembic commands ###
    
```

Done

# ‚ù§Ô∏è‚Äçüî•
