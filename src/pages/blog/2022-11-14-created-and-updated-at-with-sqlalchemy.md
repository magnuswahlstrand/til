---
layout: "../../layouts/BlogPost.astro"
title: "created_at and updated_at with SQLAlchemy"
datetime: "2022-11-14"
tags: [python, sqlalchemy, postgres]
---

Time for some more SQLAlchemy and PostgreSQL. 

We can add automatic `created_at` and `updated_at` to our SQLAlchemy models as follows:  

```python
from sqlalchemy import Column, Integer, DateTime, func
from sqlalchemy.orm import declarative_base

Base = declarative_base()


class UserMachine(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now())
```

I got the the code from [StackOverflow](https://stackoverflow.com/a/33532154). Here is a note how to turn it into [UTC](https://docs.sqlalchemy.org/en/20/core/compiler.html#utc-timestamp-function).

### So what did the code do?

A few important notes here. If we look at the migration generated by alembic (`alembic revision --autogenerate -m "add users table"`), we can see a something interesting.

```python
def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('users',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user', postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column('state', sa.String(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    # ### end Alembic commands ###
```
First of all, the `server_default=sa.text('now()')`, tells Postgres to set the default value to whatever ´now()´ returns. This is a database side function. Great!

Second, there is no mention of `onupdate`. It turns out that `onupdate` is NOT a database side function. Instead SQLAlchemy will handle this for us, and insert the value on update.
If we would use some other DB-client to perform updates, the `updated_at` column will _not_ be updated.

That is all ✨.
